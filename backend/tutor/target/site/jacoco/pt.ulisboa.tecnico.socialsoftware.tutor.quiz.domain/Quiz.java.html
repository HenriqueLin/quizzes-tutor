<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Quiz.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tutor</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.socialsoftware.tutor.quiz.domain</a> &gt; <span class="el_source">Quiz.java</span></div><h1>Quiz.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.socialsoftware.tutor.quiz.domain;

import pt.ulisboa.tecnico.socialsoftware.dtos.question.QuestionDto;
import pt.ulisboa.tecnico.socialsoftware.dtos.quiz.QuizDto;
import pt.ulisboa.tecnico.socialsoftware.dtos.quiz.QuizType;
import pt.ulisboa.tecnico.socialsoftware.exceptions.TutorException;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.domain.QuizAnswer;
import pt.ulisboa.tecnico.socialsoftware.tutor.execution.domain.CourseExecution;
import pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain.DomainEntity;
import pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain.Visitor;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.domain.Question;
import pt.ulisboa.tecnico.socialsoftware.utils.DateHandler;

import javax.persistence.*;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.IntStream;

import static pt.ulisboa.tecnico.socialsoftware.exceptions.ErrorMessage.*;

@Entity
@Table(
        name = &quot;quizzes&quot;,
        indexes = {
                @Index(name = &quot;quizzes_indx_0&quot;, columnList = &quot;course_execution_id&quot;)
        })
public class Quiz implements DomainEntity {

    @Id
    @GeneratedValue(strategy=GenerationType.IDENTITY)
    private Integer id;

    private Integer key;

    @Column(name = &quot;creation_date&quot;)
    private LocalDateTime creationDate;

    @Column(name = &quot;available_date&quot;)
    private LocalDateTime availableDate;

    @Column(name = &quot;conclusion_date&quot;)
    private LocalDateTime conclusionDate;

    @Column(name = &quot;results_date&quot;)
    private LocalDateTime resultsDate;

<span class="fc" id="L48">    @Column(columnDefinition = &quot;boolean default false&quot;)</span>
    private boolean scramble = false;

<span class="fc" id="L51">    @Column(columnDefinition = &quot;boolean default false&quot;)</span>
    private boolean qrCodeOnly = false;

<span class="fc" id="L54">    @Column(columnDefinition = &quot;boolean default false&quot;)</span>
    private boolean oneWay = false;

<span class="fc" id="L57">    @Column(nullable = false)</span>
    private String title = &quot;Title&quot;;

    @Enumerated(EnumType.STRING)
    private QuizType type;

    private Integer series;
    private String version;

<span class="fc" id="L66">    @OneToMany(cascade = CascadeType.ALL, mappedBy = &quot;quiz&quot;, fetch = FetchType.LAZY, orphanRemoval=true)</span>
    private final List&lt;QuizQuestion&gt; quizQuestions = new ArrayList&lt;&gt;();

<span class="fc" id="L69">    @OneToMany(cascade = CascadeType.ALL, mappedBy = &quot;quiz&quot;, fetch = FetchType.LAZY)</span>
    private final Set&lt;QuizAnswer&gt; quizAnswers = new HashSet&lt;&gt;();

    @ManyToOne(fetch=FetchType.EAGER, optional=false)
    @JoinColumn(name = &quot;course_execution_id&quot;)
    private CourseExecution courseExecution;

<span class="fc" id="L76">    public Quiz() {}</span>

<span class="fc" id="L78">    public Quiz(QuizDto quizDto) {</span>
<span class="fc" id="L79">        checkQuestionsSequence(quizDto.getQuestions());</span>

<span class="fc bfc" id="L81" title="All 2 branches covered.">        if (quizDto.getType() != null)</span>
<span class="fc" id="L82">            setType(quizDto.getType());</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">        else if (quizDto.isTimed())</span>
<span class="nc" id="L84">            setType(QuizType.IN_CLASS.toString());</span>
        else
<span class="fc" id="L86">            setType(QuizType.PROPOSED.toString());</span>

<span class="fc" id="L88">        setKey(quizDto.getKey());</span>
<span class="fc" id="L89">        setTitle(quizDto.getTitle());</span>
<span class="fc" id="L90">        setScramble(quizDto.isScramble());</span>
<span class="fc" id="L91">        setQrCodeOnly(quizDto.isQrCodeOnly());</span>
<span class="fc" id="L92">        setOneWay(quizDto.isOneWay());</span>
<span class="fc" id="L93">        setCreationDate(DateHandler.toLocalDateTime(quizDto.getCreationDate()));</span>
<span class="fc" id="L94">        setAvailableDate(DateHandler.toLocalDateTime(quizDto.getAvailableDate()));</span>
<span class="fc" id="L95">        setConclusionDate(DateHandler.toLocalDateTime(quizDto.getConclusionDate()));</span>
<span class="fc" id="L96">        setResultsDate(DateHandler.toLocalDateTime(quizDto.getResultsDate()));</span>
<span class="fc" id="L97">        setSeries(quizDto.getSeries());</span>
<span class="fc" id="L98">        setVersion(quizDto.getVersion());</span>
<span class="fc" id="L99">    }</span>

    @Override
    public void accept(Visitor visitor) {
<span class="fc" id="L103">        visitor.visitQuiz(this);</span>
<span class="fc" id="L104">    }</span>

    public Integer getId() {
<span class="fc" id="L107">    return id;</span>
    }

    public Integer getKey() {
<span class="fc" id="L111">        return key;</span>
    }

    public Integer getNonNullKey() {
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">        if (this.key == null)</span>
<span class="nc" id="L116">            generateKeys();</span>

<span class="fc" id="L118">        return key;</span>
    }

    public void setKey(Integer key) {
<span class="fc" id="L122">        this.key = key;</span>
<span class="fc" id="L123">    }</span>

    public boolean getScramble() {
<span class="fc" id="L126">    return scramble;</span>
    }

    public void setScramble(boolean scramble) {
<span class="fc" id="L130">    this.scramble = scramble;</span>
<span class="fc" id="L131">    }</span>

    public boolean isQrCodeOnly() {
<span class="fc" id="L134">        return qrCodeOnly;</span>
    }

    public void setQrCodeOnly(boolean qrCodeOnly) {
<span class="fc" id="L138">        this.qrCodeOnly = qrCodeOnly;</span>
<span class="fc" id="L139">    }</span>

<span class="nc bnc" id="L141" title="All 2 branches missed.">    public boolean isExternalQuiz() { return type == QuizType.EXTERNAL_QUIZ; }</span>

    public boolean isOneWay() {
<span class="fc" id="L144">        return oneWay;</span>
    }

    public void setOneWay(boolean noBack) {
<span class="fc" id="L148">        this.oneWay = noBack;</span>
<span class="fc" id="L149">    }</span>

    public String getTitle() {
<span class="fc" id="L152">    return title;</span>
    }

    public void setTitle(String title) {
<span class="fc bfc" id="L156" title="All 4 branches covered.">        if (title == null || title.isBlank())</span>
<span class="fc" id="L157">            throw new TutorException(INVALID_TITLE_FOR_QUIZ);</span>

<span class="fc" id="L159">        this.title = title;</span>
<span class="fc" id="L160">    }</span>

    public LocalDateTime getCreationDate() {
<span class="fc" id="L163">    return creationDate;</span>
    }

    public void setCreationDate(LocalDateTime creationDate) {
<span class="fc" id="L167">    this.creationDate = creationDate;</span>
<span class="fc" id="L168">    }</span>

    public LocalDateTime getAvailableDate() {
<span class="fc" id="L171">    return availableDate;</span>
    }

    public void setAvailableDate(LocalDateTime availableDate) {
<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (availableDate == null) {</span>
<span class="fc" id="L176">            throw new TutorException(INVALID_AVAILABLE_DATE_FOR_QUIZ);</span>
        }
<span class="pc bpc" id="L178" title="3 of 4 branches missed.">        if (this.conclusionDate != null &amp;&amp; conclusionDate.isBefore(availableDate)) {</span>
<span class="nc" id="L179">            throw new TutorException(INVALID_AVAILABLE_DATE_FOR_QUIZ);</span>
        }

<span class="fc" id="L182">        this.availableDate = availableDate;</span>
<span class="fc" id="L183">    }</span>

    public LocalDateTime getConclusionDate() {
<span class="fc" id="L186">    return conclusionDate;</span>
    }

    public void setConclusionDate(LocalDateTime conclusionDate) {
<span class="fc bfc" id="L190" title="All 4 branches covered.">        if (conclusionDate != null &amp;&amp; conclusionDate.isBefore(availableDate)) {</span>
<span class="fc" id="L191">            throw new TutorException(INVALID_CONCLUSION_DATE_FOR_QUIZ);</span>
        }

<span class="fc bfc" id="L194" title="All 4 branches covered.">        if (conclusionDate == null &amp;&amp; type.equals(QuizType.IN_CLASS)) {</span>
<span class="fc" id="L195">            throw new TutorException(INVALID_CONCLUSION_DATE_FOR_QUIZ);</span>
        }

<span class="fc" id="L198">        this.conclusionDate = conclusionDate;</span>
<span class="fc" id="L199">    }</span>

    public LocalDateTime getResultsDate() {
<span class="fc bfc" id="L202" title="All 2 branches covered.">        if (resultsDate == null)</span>
<span class="fc" id="L203">            return conclusionDate;</span>
<span class="fc" id="L204">        return resultsDate;</span>
    }

    public void setResultsDate(LocalDateTime resultsDate) {
<span class="fc bfc" id="L208" title="All 4 branches covered.">        if (resultsDate != null &amp;&amp; resultsDate.isBefore(availableDate)) {</span>
<span class="fc" id="L209">            throw new TutorException(INVALID_RESULTS_DATE_FOR_QUIZ);</span>
        }
<span class="fc bfc" id="L211" title="All 6 branches covered.">        if (resultsDate != null &amp;&amp; conclusionDate != null &amp;&amp; resultsDate.isBefore(conclusionDate)) {</span>
<span class="fc" id="L212">            throw new TutorException(INVALID_RESULTS_DATE_FOR_QUIZ);</span>
        }

<span class="fc" id="L215">        this.resultsDate = resultsDate;</span>
<span class="fc" id="L216">    }</span>

    public QuizType getType() {
<span class="fc" id="L219">        return type;</span>
    }

    public void setType(String type) {
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        if (type == null)</span>
<span class="nc" id="L224">            throw new TutorException(INVALID_TYPE_FOR_QUIZ);</span>

        try {
<span class="fc" id="L227">            this.type = QuizType.valueOf(type);</span>
<span class="fc" id="L228">        } catch (IllegalArgumentException e) {</span>
<span class="fc" id="L229">            throw new TutorException(INVALID_TYPE_FOR_QUIZ);</span>
<span class="fc" id="L230">        }</span>
<span class="fc" id="L231">    }</span>

    public Integer getSeries() {
<span class="fc" id="L234">        return series;</span>
    }

    public void setSeries(Integer series) {
<span class="fc" id="L238">        this.series = series;</span>
<span class="fc" id="L239">    }</span>

    public String getVersion() {
<span class="fc" id="L242">        return version;</span>
    }

    public void setVersion(String version) {
<span class="fc" id="L246">        this.version = version;</span>
<span class="fc" id="L247">    }</span>

    public List&lt;QuizQuestion&gt; getQuizQuestions() {
<span class="fc" id="L250">        return this.quizQuestions.stream().sorted(Comparator.comparing(QuizQuestion::getSequence)).collect(Collectors.toList());</span>
    }

    public int getQuizQuestionsNumber() {
<span class="fc" id="L254">        return this.quizQuestions.size();</span>
    }

    public Set&lt;QuizAnswer&gt; getQuizAnswers() {
<span class="fc" id="L258">        return quizAnswers;</span>
    }

    public CourseExecution getCourseExecution() {
<span class="fc" id="L262">        return courseExecution;</span>
    }

    public void setCourseExecution(CourseExecution courseExecution) {
<span class="fc" id="L266">        this.courseExecution = courseExecution;</span>
<span class="fc" id="L267">        courseExecution.addQuiz(this);</span>
<span class="fc" id="L268">    }</span>

    public void addQuizQuestion(QuizQuestion quizQuestion) {
<span class="fc" id="L271">        this.quizQuestions.add(quizQuestion);</span>
<span class="fc" id="L272">    }</span>

    public void removeQuizQuestion(QuizQuestion quizQuestion) {
<span class="fc" id="L275">        this.quizQuestions.remove(quizQuestion);</span>
<span class="fc" id="L276">    }</span>

    public void addQuizAnswer(QuizAnswer quizAnswer) {
<span class="fc" id="L279">        this.quizAnswers.add(quizAnswer);</span>
<span class="fc" id="L280">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L284">        return &quot;Quiz{&quot; +</span>
                &quot;id=&quot; + id +
                &quot;, key=&quot; + key +
                &quot;, creationDate=&quot; + creationDate +
                &quot;, availableDate=&quot; + availableDate +
                &quot;, conclusionDate=&quot; + conclusionDate +
                &quot;, resultsDate=&quot; + resultsDate +
                &quot;, scramble=&quot; + scramble +
                &quot;, qrCodeOnly=&quot; + qrCodeOnly +
                &quot;, oneWay=&quot; + oneWay +
                &quot;, title='&quot; + title + '\'' +
                &quot;, type=&quot; + type +
                &quot;, series=&quot; + series +
                &quot;, version='&quot; + version + '\'' +
                &quot;, quizQuestions=&quot; + quizQuestions +
                '}';
    }

    private void generateKeys() {
<span class="nc" id="L303">        int max = this.courseExecution.getQuizzes().stream()</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">                .filter(quiz -&gt; quiz.key != null)</span>
<span class="nc" id="L305">                .map(Quiz::getKey)</span>
<span class="nc" id="L306">                .max(Comparator.comparing(Integer::valueOf))</span>
<span class="nc" id="L307">                .orElse(0);</span>

<span class="nc" id="L309">        List&lt;Quiz&gt; nullKeyQuizzes = this.courseExecution.getQuizzes().stream()</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">                .filter(quiz -&gt; quiz.key == null).collect(Collectors.toList());</span>

<span class="nc bnc" id="L312" title="All 2 branches missed.">        for (Quiz quiz: nullKeyQuizzes) {</span>
<span class="nc" id="L313">            max = max + 1;</span>
<span class="nc" id="L314">            quiz.key = max;</span>
<span class="nc" id="L315">        }</span>
<span class="nc" id="L316">    }</span>

    private void checkQuestionsSequence(List&lt;QuestionDto&gt; questions) {
<span class="pc bpc" id="L319" title="1 of 2 branches missed.">        if (questions != null) {</span>
<span class="fc bfc" id="L320" title="All 2 branches covered.">            for (QuestionDto questionDto : questions) {</span>
<span class="fc bfc" id="L321" title="All 2 branches covered.">                if (questionDto.getSequence() != questions.indexOf(questionDto) + 1) {</span>
<span class="fc" id="L322">                    throw new TutorException(INVALID_QUESTION_SEQUENCE_FOR_QUIZ);</span>
                }
<span class="fc" id="L324">            }</span>
        }
<span class="fc" id="L326">    }</span>

    public void remove() {
<span class="fc" id="L329">        checkCanChange();</span>

<span class="pc bpc" id="L331" title="1 of 2 branches missed.">        if(this.getType().equals(QuizType.EXTERNAL_QUIZ)) {</span>
<span class="nc" id="L332">            throw new TutorException(EXTERNAL_CANNOT_BE_REMOVED);</span>
        }

<span class="fc" id="L335">        this.courseExecution.getQuizzes().remove(this);</span>
<span class="fc" id="L336">        this.courseExecution = null;</span>
<span class="fc" id="L337">    }</span>

    public void removeExternal() {
<span class="nc" id="L340">        checkCanChange();</span>

<span class="nc" id="L342">        this.courseExecution.getQuizzes().remove(this);</span>
<span class="nc" id="L343">        this.courseExecution = null;</span>
<span class="nc" id="L344">    }</span>

    public void checkCanChange() {
<span class="fc bfc" id="L347" title="All 2 branches covered.">        if (!quizAnswers.isEmpty()) {</span>
<span class="fc" id="L348">            throw new TutorException(QUIZ_HAS_ANSWERS);</span>
        }
<span class="fc" id="L350">        this.quizQuestions.forEach(QuizQuestion::checkCanRemove);</span>
<span class="fc" id="L351">    }</span>

    public void generateQuiz(List&lt;Question&gt; questions) {
<span class="fc" id="L354">        IntStream.range(0,questions.size())</span>
<span class="fc" id="L355">                .forEach(index -&gt; new QuizQuestion(this, questions.get(index), index));</span>

<span class="fc" id="L357">        setAvailableDate(DateHandler.now());</span>
<span class="fc" id="L358">        setCreationDate(DateHandler.now());</span>
<span class="fc" id="L359">        setType(QuizType.GENERATED.toString());</span>
<span class="fc" id="L360">        setTitle(&quot;Generated Quiz&quot;);</span>
<span class="fc" id="L361">    }</span>

    public QuizDto getDto(boolean deepCopy) {
<span class="fc" id="L364">        QuizDto dto = new QuizDto();</span>
<span class="fc" id="L365">        dto.setId(getId());</span>
<span class="fc" id="L366">        dto.setKey(getKey());</span>
<span class="fc" id="L367">        dto.setScramble(getScramble());</span>
<span class="fc" id="L368">        dto.setQrCodeOnly(isQrCodeOnly());</span>
<span class="fc" id="L369">        dto.setOneWay(isOneWay());</span>
<span class="fc" id="L370">        dto.setTitle(getTitle());</span>
<span class="fc" id="L371">        dto.setTimed(getType().equals(QuizType.IN_CLASS));</span>
<span class="fc" id="L372">        dto.setType(getType().toString());</span>
<span class="fc" id="L373">        dto.setSeries(getSeries());</span>
<span class="fc" id="L374">        dto.setVersion(getVersion());</span>
<span class="fc" id="L375">        dto.setNumberOfQuestions(getQuizQuestionsNumber());</span>
<span class="fc" id="L376">        dto.setNumberOfAnswers(getQuizAnswers().size());</span>
<span class="fc" id="L377">        dto.setCreationDate(DateHandler.toISOString(getCreationDate()));</span>
<span class="fc" id="L378">        dto.setAvailableDate(DateHandler.toISOString(getAvailableDate()));</span>
<span class="fc" id="L379">        dto.setConclusionDate(DateHandler.toISOString(getConclusionDate()));</span>
<span class="fc" id="L380">        dto.setResultsDate(DateHandler.toISOString(getResultsDate()));</span>

<span class="fc bfc" id="L382" title="All 2 branches covered.">        if (deepCopy) {</span>
<span class="fc" id="L383">            dto.setQuestions(getQuizQuestions().stream()</span>
<span class="fc" id="L384">                    .map(quizQuestion -&gt; {</span>
<span class="fc" id="L385">                        QuestionDto questionDto = quizQuestion.getQuestion().getDto();</span>
<span class="fc" id="L386">                        questionDto.setSequence(quizQuestion.getSequence());</span>
<span class="fc" id="L387">                        return questionDto;</span>
                    })
<span class="fc" id="L389">                    .collect(Collectors.toList()));</span>
        }

<span class="fc" id="L392">        return dto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>