<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuestionsXmlImport.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tutor</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain</a> &gt; <span class="el_source">QuestionsXmlImport.java</span></div><h1>QuestionsXmlImport.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain;

import org.jdom2.Document;
import org.jdom2.Element;
import org.jdom2.JDOMException;
import org.jdom2.filter.Filters;
import org.jdom2.input.SAXBuilder;
import org.jdom2.xpath.XPathExpression;
import org.jdom2.xpath.XPathFactory;
import pt.ulisboa.tecnico.socialsoftware.dtos.question.*;
import pt.ulisboa.tecnico.socialsoftware.exceptions.TutorException;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.QuestionService;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.domain.Course;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.repository.CourseRepository;

import java.io.*;
import java.nio.charset.Charset;
import java.util.ArrayList;
import java.util.List;

import static pt.ulisboa.tecnico.socialsoftware.exceptions.ErrorMessage.*;

<span class="fc" id="L23">public class QuestionsXmlImport {</span>
    private QuestionService questionService;
    private CourseRepository courseRepository;

    public void importQuestions(InputStream inputStream, QuestionService questionService, CourseRepository courseRepository) {
<span class="fc" id="L28">        this.questionService = questionService;</span>
<span class="fc" id="L29">        this.courseRepository = courseRepository;</span>

<span class="fc" id="L31">        SAXBuilder builder = new SAXBuilder();</span>
<span class="fc" id="L32">        builder.setIgnoringElementContentWhitespace(true);</span>

        Document doc;
        try {
<span class="fc" id="L36">            Reader reader = new InputStreamReader(inputStream, Charset.defaultCharset());</span>
<span class="fc" id="L37">            doc = builder.build(reader);</span>
<span class="nc" id="L38">        } catch (FileNotFoundException e) {</span>
<span class="nc" id="L39">            throw new TutorException(QUESTIONS_IMPORT_ERROR, &quot;File not found&quot;);</span>
<span class="nc" id="L40">        } catch (JDOMException e) {</span>
<span class="nc" id="L41">            throw new TutorException(QUESTIONS_IMPORT_ERROR, &quot;Coding problem&quot;);</span>
<span class="nc" id="L42">        } catch (IOException e) {</span>
<span class="nc" id="L43">            throw new TutorException(QUESTIONS_IMPORT_ERROR, &quot;File type or format&quot;);</span>
<span class="fc" id="L44">        }</span>

<span class="pc bpc" id="L46" title="1 of 2 branches missed.">        if (doc == null) {</span>
<span class="nc" id="L47">            throw new TutorException(QUESTIONS_IMPORT_ERROR, &quot;File not found ot format error&quot;);</span>
        }

<span class="fc" id="L50">        importQuestions(doc);</span>
<span class="fc" id="L51">    }</span>

    public void importQuestions(String questionsXml, QuestionService questionService, CourseRepository courseRepository) {
<span class="fc" id="L54">        SAXBuilder builder = new SAXBuilder();</span>
<span class="fc" id="L55">        builder.setIgnoringElementContentWhitespace(true);</span>

<span class="fc" id="L57">        InputStream stream = new ByteArrayInputStream(questionsXml.getBytes());</span>

<span class="fc" id="L59">        importQuestions(stream, questionService, courseRepository);</span>
<span class="fc" id="L60">    }</span>

    private void importQuestions(Document doc) {
<span class="fc" id="L63">        XPathFactory xpfac = XPathFactory.instance();</span>
<span class="fc" id="L64">        XPathExpression&lt;Element&gt; xp = xpfac.compile(&quot;//questions/question&quot;, Filters.element());</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">        for (Element element : xp.evaluate(doc)) {</span>
<span class="fc" id="L66">            importQuestion(element);</span>
<span class="fc" id="L67">        }</span>
<span class="fc" id="L68">    }</span>

    private void importQuestion(Element questionElement) {
<span class="fc" id="L71">        String courseType = questionElement.getAttributeValue(&quot;courseType&quot;);</span>
<span class="fc" id="L72">        String courseName = questionElement.getAttributeValue(&quot;courseName&quot;);</span>
<span class="fc" id="L73">        Integer key = Integer.valueOf(questionElement.getAttributeValue(&quot;key&quot;));</span>
<span class="fc" id="L74">        String content = questionElement.getAttributeValue(&quot;content&quot;);</span>
<span class="fc" id="L75">        String title = questionElement.getAttributeValue(&quot;title&quot;);</span>
<span class="fc" id="L76">        String status = questionElement.getAttributeValue(&quot;status&quot;);</span>
<span class="fc" id="L77">        String creationDate = questionElement.getAttributeValue(&quot;creationDate&quot;);</span>
<span class="fc" id="L78">        String type = questionElement.getAttributeValue(&quot;type&quot;);</span>

<span class="fc" id="L80">        QuestionDto questionDto = new QuestionDto();</span>
<span class="fc" id="L81">        questionDto.setKey(key);</span>
<span class="fc" id="L82">        questionDto.setContent(content);</span>
<span class="fc" id="L83">        questionDto.setTitle(title);</span>
<span class="fc" id="L84">        questionDto.setStatus(status);</span>
<span class="fc" id="L85">        questionDto.setCreationDate(creationDate);</span>

<span class="fc" id="L87">        Element imageElement = questionElement.getChild(&quot;image&quot;);</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        if (imageElement != null) {</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">            Integer width = imageElement.getAttributeValue(&quot;width&quot;) != null ?</span>
<span class="pc" id="L90">                    Integer.valueOf(imageElement.getAttributeValue(&quot;width&quot;)) : null;</span>
<span class="fc" id="L91">            String url = imageElement.getAttributeValue(&quot;url&quot;);</span>

<span class="fc" id="L93">            ImageDto imageDto = new ImageDto();</span>
<span class="fc" id="L94">            imageDto.setWidth(width);</span>
<span class="fc" id="L95">            imageDto.setUrl(url);</span>

<span class="fc" id="L97">            questionDto.setImage(imageDto);</span>
        }

        QuestionDetailsDto questionDetailsDto;
<span class="pc bpc" id="L101" title="1 of 4 branches missed.">        switch (type) {</span>
            case QuestionTypes.MULTIPLE_CHOICE_QUESTION:
<span class="fc" id="L103">                questionDetailsDto = importMultipleChoiceQuestion(questionElement);</span>
<span class="fc" id="L104">                break;</span>
            case QuestionTypes.CODE_FILL_IN_QUESTION:
<span class="fc" id="L106">                questionDetailsDto = importCodeFillInQuestion(questionElement);</span>
<span class="fc" id="L107">                break;</span>
            case QuestionTypes.CODE_ORDER_QUESTION:
<span class="fc" id="L109">                questionDetailsDto = importCodeOrderQuestion(questionElement);</span>
<span class="fc" id="L110">                break;</span>
            default:
<span class="nc" id="L112">                throw new TutorException(QUESTION_TYPE_NOT_IMPLEMENTED, type);</span>
        }

<span class="fc" id="L115">        questionDto.setQuestionDetailsDto(questionDetailsDto);</span>

<span class="pc" id="L117">        Course course = courseRepository.findByNameType(courseName, courseType).orElseThrow(() -&gt; new TutorException(COURSE_NOT_FOUND, courseName));</span>
<span class="fc" id="L118">        questionService.createQuestion(course.getId(), questionDto);</span>
<span class="fc" id="L119">    }</span>

    private QuestionDetailsDto importMultipleChoiceQuestion(Element questionElement) {
<span class="fc" id="L122">        List&lt;OptionDto&gt; optionDtos = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">        for (Element optionElement : questionElement.getChild(&quot;options&quot;).getChildren(&quot;option&quot;)) {</span>
<span class="fc" id="L124">            Integer optionSequence = Integer.valueOf(optionElement.getAttributeValue(&quot;sequence&quot;));</span>
<span class="fc" id="L125">            String optionContent = optionElement.getAttributeValue(&quot;content&quot;);</span>
<span class="fc" id="L126">            boolean correct = Boolean.parseBoolean(optionElement.getAttributeValue(&quot;correct&quot;));</span>

<span class="fc" id="L128">            OptionDto optionDto = new OptionDto();</span>
<span class="fc" id="L129">            optionDto.setSequence(optionSequence);</span>
<span class="fc" id="L130">            optionDto.setContent(optionContent);</span>
<span class="fc" id="L131">            optionDto.setCorrect(correct);</span>

<span class="fc" id="L133">            optionDtos.add(optionDto);</span>
<span class="fc" id="L134">        }</span>
<span class="fc" id="L135">        MultipleChoiceQuestionDto multipleChoiceQuestionDto = new MultipleChoiceQuestionDto();</span>
<span class="fc" id="L136">        multipleChoiceQuestionDto.setOptions(optionDtos);</span>
<span class="fc" id="L137">        return multipleChoiceQuestionDto;</span>
    }

    private QuestionDetailsDto importCodeFillInQuestion(Element questionElement) {
<span class="fc" id="L141">        CodeFillInQuestionDto questionDto = new CodeFillInQuestionDto();</span>
<span class="fc" id="L142">        questionDto.setCode(questionElement.getChildText(&quot;code&quot;));</span>
<span class="fc" id="L143">        questionDto.setLanguage(Languages.valueOf(questionElement.getChild(&quot;code&quot;).getAttributeValue(&quot;language&quot;)));</span>
<span class="fc" id="L144">        var spots = new ArrayList&lt;CodeFillInSpotDto&gt;();</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        for (Element spotElement : questionElement.getChild(&quot;fillInSpots&quot;).getChildren(&quot;fillInSpot&quot;)) {</span>
<span class="fc" id="L146">            var spot = new CodeFillInSpotDto();</span>
<span class="fc" id="L147">            spot.setSequence(Integer.valueOf(spotElement.getAttributeValue(&quot;sequence&quot;)));</span>
<span class="fc" id="L148">            var options = new ArrayList&lt;OptionDto&gt;();</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">            for (Element optionElement : spotElement.getChildren(&quot;fillInOption&quot;)) {</span>
<span class="fc" id="L150">                Integer optionSequence = Integer.valueOf(optionElement.getAttributeValue(&quot;sequence&quot;));</span>
<span class="fc" id="L151">                String optionContent = optionElement.getAttributeValue(&quot;content&quot;);</span>
<span class="fc" id="L152">                boolean correct = Boolean.parseBoolean(optionElement.getAttributeValue(&quot;correct&quot;));</span>

<span class="fc" id="L154">                OptionDto optionDto = new OptionDto();</span>
<span class="fc" id="L155">                optionDto.setSequence(optionSequence);</span>
<span class="fc" id="L156">                optionDto.setContent(optionContent);</span>
<span class="fc" id="L157">                optionDto.setCorrect(correct);</span>

<span class="fc" id="L159">                options.add(optionDto);</span>
<span class="fc" id="L160">            }</span>

<span class="fc" id="L162">            spot.setOptions(options);</span>
<span class="fc" id="L163">            spots.add(spot);</span>
<span class="fc" id="L164">        }</span>
<span class="fc" id="L165">        questionDto.setFillInSpots(spots);</span>
<span class="fc" id="L166">        return questionDto;</span>
    }

    private QuestionDetailsDto importCodeOrderQuestion(Element questionElement) {
<span class="fc" id="L170">        CodeOrderQuestionDto questionDto = new CodeOrderQuestionDto();</span>
<span class="fc" id="L171">        questionDto.setLanguage(Languages.valueOf(questionElement.getChild(&quot;orderSlots&quot;).getAttributeValue(&quot;language&quot;)));</span>
<span class="fc" id="L172">        var slots = new ArrayList&lt;CodeOrderSlotDto&gt;();</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">        for (Element slotElement : questionElement.getChild(&quot;orderSlots&quot;).getChildren(&quot;slot&quot;)) {</span>
<span class="fc" id="L174">            var slot = new CodeOrderSlotDto();</span>
<span class="fc" id="L175">            slot.setOrder(Integer.valueOf(slotElement.getAttributeValue(&quot;order&quot;)));</span>
<span class="fc" id="L176">            slot.setSequence(Integer.valueOf(slotElement.getAttributeValue(&quot;sequence&quot;)));</span>
<span class="fc" id="L177">            slot.setContent(slotElement.getValue());</span>

<span class="fc" id="L179">            slots.add(slot);</span>
<span class="fc" id="L180">        }</span>
<span class="fc" id="L181">        questionDto.setCodeOrderSlots(slots);</span>
<span class="fc" id="L182">        return questionDto;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>