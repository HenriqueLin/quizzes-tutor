<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnswerService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tutor</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.socialsoftware.tutor.answer</a> &gt; <span class="el_source">AnswerService.java</span></div><h1>AnswerService.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.socialsoftware.tutor.answer;

import com.google.common.eventbus.EventBus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.retry.annotation.Backoff;
import org.springframework.retry.annotation.Retryable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Transactional;
import pt.ulisboa.tecnico.socialsoftware.dtos.quiz.QuizDto;
import pt.ulisboa.tecnico.socialsoftware.dtos.quiz.QuizType;
import pt.ulisboa.tecnico.socialsoftware.dtos.tournament.ExternalStatementCreationDto;
import pt.ulisboa.tecnico.socialsoftware.exceptions.TutorException;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.domain.*;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.dto.*;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.repository.AnswerDetailsRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.repository.QuestionAnswerItemRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.repository.QuizAnswerItemRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.repository.QuizAnswerRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.execution.CourseExecutionService;
import pt.ulisboa.tecnico.socialsoftware.tutor.execution.domain.Assessment;
import pt.ulisboa.tecnico.socialsoftware.tutor.execution.domain.CourseExecution;
import pt.ulisboa.tecnico.socialsoftware.tutor.execution.repository.AssessmentRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain.AnswersXmlExportVisitor;
import pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain.AnswersXmlImport;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.domain.Question;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.repository.QuestionRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.quiz.domain.Quiz;
import pt.ulisboa.tecnico.socialsoftware.tutor.quiz.repository.CourseExecutionRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.quiz.repository.QuizRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.user.domain.User;
import pt.ulisboa.tecnico.socialsoftware.tutor.user.repository.UserRepository;
import pt.ulisboa.tecnico.socialsoftware.utils.DateHandler;

import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.temporal.ChronoUnit;
import java.util.*;
import java.util.function.Function;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static pt.ulisboa.tecnico.socialsoftware.exceptions.ErrorMessage.*;

@Service
<span class="fc" id="L46">public class AnswerService {</span>
    @Autowired
    private UserRepository userRepository;

    @Autowired
    private QuizRepository quizRepository;

    @Autowired
    private QuizAnswerRepository quizAnswerRepository;

    @Autowired
    private AnswerDetailsRepository answerDetailsRepository;

    @Autowired
    private QuizAnswerItemRepository quizAnswerItemRepository;

    @Autowired
    private CourseExecutionRepository courseExecutionRepository;

    @Autowired
    private QuestionAnswerItemRepository questionAnswerItemRepository;

    @Autowired
    private QuestionRepository questionRepository;

    @Autowired
    private AssessmentRepository assessmentRepository;

    @Autowired
    private AnswersXmlImport xmlImporter;

    @Autowired
    private CourseExecutionService courseExecutionService;

    @Autowired
    private EventBus eventBus;

    @Retryable(
            value = {SQLException.class},
            backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public QuizAnswerDto createQuizAnswer(Integer userId, Integer quizId) {
<span class="pc" id="L88">        User user = userRepository.findById(userId).orElseThrow(() -&gt; new TutorException(USER_NOT_FOUND, userId));</span>

<span class="pc" id="L90">        Quiz quiz = quizRepository.findById(quizId).orElseThrow(() -&gt; new TutorException(QUIZ_NOT_FOUND, quizId));</span>

<span class="fc" id="L92">        QuizAnswer quizAnswer = new QuizAnswer(user, quiz);</span>
<span class="fc" id="L93">        quizAnswerRepository.save(quizAnswer);</span>

<span class="fc" id="L95">        return new QuizAnswerDto(quizAnswer);</span>
    }

    @Retryable(
            value = {SQLException.class},
            backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public List&lt;CorrectAnswerDto&gt; concludeQuiz(StatementQuizDto statementQuizDto) {
<span class="fc" id="L103">        QuizAnswer quizAnswer = quizAnswerRepository.findById(statementQuizDto.getQuizAnswerId())</span>
<span class="pc" id="L104">                .orElseThrow(() -&gt; new TutorException(QUIZ_ANSWER_NOT_FOUND, statementQuizDto.getId()));</span>

<span class="pc bpc" id="L106" title="1 of 4 branches missed.">        if (quizAnswer.getQuiz().getAvailableDate() != null &amp;&amp; quizAnswer.getQuiz().getAvailableDate().isAfter(DateHandler.now())) {</span>
<span class="fc" id="L107">            throw new TutorException(QUIZ_NOT_YET_AVAILABLE);</span>
        }

<span class="fc bfc" id="L110" title="All 4 branches covered.">        if (quizAnswer.getQuiz().getConclusionDate() != null &amp;&amp; quizAnswer.getQuiz().getConclusionDate().isBefore(DateHandler.now().minusMinutes(10))) {</span>
<span class="fc" id="L111">            throw new TutorException(QUIZ_NO_LONGER_AVAILABLE);</span>
        }

<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (!quizAnswer.isCompleted()) {</span>
<span class="fc" id="L115">            quizAnswer.setCompleted(true);</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">            if (quizAnswer.getQuiz().getType().equals(QuizType.IN_CLASS)) {</span>
<span class="fc" id="L118">                QuizAnswerItem quizAnswerItem = new QuizAnswerItem(statementQuizDto);</span>
<span class="fc" id="L119">                quizAnswerItemRepository.save(quizAnswerItem);</span>
<span class="fc" id="L120">            } else {</span>
<span class="fc" id="L121">                quizAnswer.setAnswerDate(DateHandler.now());</span>

<span class="fc bfc" id="L123" title="All 2 branches covered.">                for (QuestionAnswer questionAnswer : quizAnswer.getQuestionAnswers()) {</span>
<span class="fc" id="L124">                    writeQuestionAnswer(questionAnswer, statementQuizDto.getAnswers());</span>
<span class="fc" id="L125">                }</span>

<span class="fc" id="L127">                List&lt;CorrectAnswerDto&gt; correctAnswerDtoList = quizAnswer.getQuestionAnswers().stream()</span>
<span class="fc" id="L128">                        .sorted(Comparator.comparing(QuestionAnswer::getSequence))</span>
<span class="fc" id="L129">                        .map(CorrectAnswerDto::new)</span>
<span class="fc" id="L130">                        .collect(Collectors.toList());</span>

                // TODO: Confirmar
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">                if (quizAnswer.getQuiz().getType().equals(QuizType.EXTERNAL_QUIZ)) {</span>
<span class="nc" id="L134">                    ExternalQuizSolvedEvent event = new ExternalQuizSolvedEvent(quizAnswer.getQuiz().getId(),</span>
<span class="nc" id="L135">                            quizAnswer.getUser().getId(), quizAnswer.getNumberOfAnsweredQuestions(),</span>
<span class="nc" id="L136">                            quizAnswer.getNumberOfCorrectAnswers());</span>

<span class="nc" id="L138">                    eventBus.post(event);</span>
                }

<span class="fc" id="L141">                return correctAnswerDtoList;</span>
            }
        }
<span class="fc" id="L144">        return new ArrayList&lt;&gt;();</span>
    }

    @Retryable(
            value = {SQLException.class},
            backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void writeQuizAnswers(Integer quizId) {
<span class="nc" id="L152">        Quiz quiz = quizRepository.findQuizWithAnswersAndQuestionsById(quizId).orElseThrow(() -&gt; new TutorException(QUIZ_NOT_FOUND, quizId));</span>
<span class="nc" id="L153">        Map&lt;Integer, QuizAnswer&gt; quizAnswersMap = quiz.getQuizAnswers().stream().collect(Collectors.toMap(QuizAnswer::getId, Function.identity()));</span>

<span class="nc" id="L155">        List&lt;QuizAnswerItem&gt; quizAnswerItems = quizAnswerItemRepository.findQuizAnswerItemsByQuizId(quizId);</span>

<span class="nc" id="L157">        quizAnswerItems.forEach(quizAnswerItem -&gt; {</span>
<span class="nc" id="L158">            QuizAnswer quizAnswer = quizAnswersMap.get(quizAnswerItem.getQuizAnswerId());</span>

<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (quizAnswer.getAnswerDate() == null) {</span>
<span class="nc" id="L161">                quizAnswer.setAnswerDate(quizAnswerItem.getAnswerDate());</span>

<span class="nc bnc" id="L163" title="All 2 branches missed.">                for (QuestionAnswer questionAnswer : quizAnswer.getQuestionAnswers()) {</span>
<span class="nc" id="L164">                    writeQuestionAnswer(questionAnswer, quizAnswerItem.getAnswersList());</span>
<span class="nc" id="L165">                }</span>
            }
<span class="nc" id="L167">            quizAnswerItemRepository.deleteById(quizAnswerItem.getId());</span>
<span class="nc" id="L168">        });</span>
<span class="nc" id="L169">    }</span>

    private void writeQuestionAnswer(QuestionAnswer questionAnswer, List&lt;StatementAnswerDto&gt; statementAnswerDtoList) {
<span class="fc" id="L172">        StatementAnswerDto statementAnswerDto = statementAnswerDtoList.stream()</span>
<span class="fc" id="L173">                .filter(statementAnswerDto1 -&gt; statementAnswerDto1.getQuestionAnswerId().equals(questionAnswer.getId()))</span>
<span class="fc" id="L174">                .findAny()</span>
<span class="pc" id="L175">                .orElseThrow(() -&gt; new TutorException(QUESTION_ANSWER_NOT_FOUND, questionAnswer.getId()));</span>

<span class="fc" id="L177">        questionAnswer.setTimeTaken(statementAnswerDto.getTimeTaken());</span>
<span class="fc" id="L178">        AnswerDetails answer = questionAnswer.setAnswerDetails(statementAnswerDto);</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">        if (answer != null) {</span>
<span class="fc" id="L180">            answerDetailsRepository.save(answer);</span>
        }
<span class="fc" id="L182">    }</span>

    @Retryable(
            value = {SQLException.class},
            backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public String exportAnswers() {
<span class="fc" id="L189">        AnswersXmlExportVisitor xmlExport = new AnswersXmlExportVisitor();</span>

<span class="fc" id="L191">        return xmlExport.export(quizAnswerRepository.findAll());</span>
    }

    @Retryable(
            value = {SQLException.class},
            backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void importAnswers(String answersXml) {
<span class="fc" id="L199">        xmlImporter.importAnswers(answersXml);</span>
<span class="fc" id="L200">    }</span>

    @Retryable(
            value = {SQLException.class},
            backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void deleteQuizAnswer(QuizAnswer quizAnswer) {
<span class="fc" id="L207">        quizAnswer.remove();</span>
<span class="fc" id="L208">        quizAnswerRepository.delete(quizAnswer);</span>
<span class="fc" id="L209">    }</span>

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public StatementQuizDto generateStudentQuiz(int userId, int executionId, StatementCreationDto quizDetails) {
<span class="pc" id="L216">        User user = userRepository.findById(userId).orElseThrow(() -&gt; new TutorException(USER_NOT_FOUND, userId));</span>

<span class="fc" id="L218">        Quiz quiz = new Quiz();</span>
<span class="fc" id="L219">        quiz.setType(QuizType.GENERATED.toString());</span>
<span class="fc" id="L220">        quiz.setCreationDate(DateHandler.now());</span>

<span class="pc" id="L222">        CourseExecution courseExecution = courseExecutionRepository.findById(executionId).orElseThrow(() -&gt; new TutorException(COURSE_EXECUTION_NOT_FOUND, executionId));</span>

<span class="fc" id="L224">        List&lt;Question&gt; availableQuestions = questionRepository.findAvailableQuestions(courseExecution.getCourse().getId());</span>

<span class="fc bfc" id="L226" title="All 2 branches covered.">        if (quizDetails.getAssessment() != null) {</span>
<span class="fc" id="L227">            availableQuestions = filterByAssessment(availableQuestions, quizDetails);</span>
        } else {
<span class="fc" id="L229">            availableQuestions = new ArrayList&lt;&gt;();</span>
        }

<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (availableQuestions.size() &lt; quizDetails.getNumberOfQuestions()) {</span>
<span class="fc" id="L233">            throw new TutorException(NOT_ENOUGH_QUESTIONS);</span>
        }

<span class="fc" id="L236">        availableQuestions = user.filterQuestionsByStudentModel(quizDetails.getNumberOfQuestions(), availableQuestions);</span>

<span class="fc" id="L238">        quiz.generateQuiz(availableQuestions);</span>

<span class="fc" id="L240">        QuizAnswer quizAnswer = new QuizAnswer(user, quiz);</span>

<span class="fc" id="L242">        quiz.setCourseExecution(courseExecution);</span>

<span class="fc" id="L244">        quizRepository.save(quiz);</span>

<span class="fc" id="L246">        return new StatementQuizDto(quizAnswer, false);</span>
    }

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public StatementQuizDto generateTournamentQuiz(int userId, int executionId, ExternalStatementCreationDto quizDetails) {
<span class="nc" id="L254">        User user = userRepository.findById(userId).orElseThrow(() -&gt; new TutorException(USER_NOT_FOUND, userId));</span>

<span class="nc" id="L256">        Quiz quiz = new Quiz();</span>
<span class="nc" id="L257">        quiz.setType(QuizType.GENERATED.toString());</span>
<span class="nc" id="L258">        quiz.setCreationDate(DateHandler.now());</span>

<span class="nc" id="L260">        CourseExecution courseExecution = courseExecutionRepository.findById(executionId).orElseThrow(() -&gt; new TutorException(COURSE_EXECUTION_NOT_FOUND, executionId));</span>

<span class="nc" id="L262">        List&lt;Question&gt; availableQuestions = questionRepository.findAvailableQuestions(courseExecution.getCourse().getId());</span>

<span class="nc bnc" id="L264" title="All 2 branches missed.">        if (quizDetails.getTopics() != null) {</span>
<span class="nc" id="L265">            availableQuestions = courseExecution.filterQuestionsByTopics(availableQuestions, quizDetails.getTopics());</span>
        } else {
<span class="nc" id="L267">            availableQuestions = new ArrayList&lt;&gt;();</span>
        }

<span class="nc bnc" id="L270" title="All 2 branches missed.">        if (availableQuestions.size() &lt; quizDetails.getNumberOfQuestions()) {</span>
<span class="nc" id="L271">            throw new TutorException(NOT_ENOUGH_QUESTIONS_TOURNAMENT);</span>
        }

<span class="nc" id="L274">        availableQuestions = user.filterQuestionsByStudentModel(quizDetails.getNumberOfQuestions(), availableQuestions);</span>

<span class="nc" id="L276">        quiz.generateQuiz(availableQuestions);</span>

<span class="nc" id="L278">        QuizAnswer quizAnswer = new QuizAnswer(user, quiz);</span>

<span class="nc" id="L280">        quiz.setCourseExecution(courseExecution);</span>

<span class="nc bnc" id="L282" title="All 2 branches missed.">        if (DateHandler.now().isBefore(quizDetails.getStartTime())) {</span>
<span class="nc" id="L283">            quiz.setAvailableDate(quizDetails.getStartTime());</span>
        }
<span class="nc" id="L285">        quiz.setConclusionDate(quizDetails.getEndTime());</span>
<span class="nc" id="L286">        quiz.setResultsDate(quizDetails.getEndTime());</span>
<span class="nc" id="L287">        quiz.setTitle(&quot;Tournament &quot; + quizDetails.getId() + &quot; Quiz&quot;);</span>
<span class="nc" id="L288">        quiz.setType(QuizType.EXTERNAL_QUIZ.toString());</span>

<span class="nc" id="L290">        quizRepository.save(quiz);</span>

<span class="nc" id="L292">        return new StatementQuizDto(quizAnswer, false);</span>
    }

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public StatementQuizDto getQuizByQRCode(int userId, int quizId) {
<span class="pc" id="L300">        User user = userRepository.findById(userId).orElseThrow(() -&gt; new TutorException(USER_NOT_FOUND, userId));</span>
<span class="pc" id="L301">        Quiz quiz = quizRepository.findById(quizId).orElseThrow(() -&gt; new TutorException(QUIZ_NOT_FOUND, quizId));</span>

<span class="fc bfc" id="L303" title="All 2 branches covered.">        if (!quiz.isQrCodeOnly()) {</span>
<span class="fc" id="L304">            throw new TutorException(NOT_QRCODE_QUIZ);</span>
        }

<span class="pc bpc" id="L307" title="1 of 2 branches missed.">        if (!user.getCourseExecutions().contains(quiz.getCourseExecution())) {</span>
<span class="nc" id="L308">            throw new TutorException(USER_NOT_ENROLLED, user.getUsername());</span>
        }

<span class="fc bfc" id="L311" title="All 4 branches covered.">        if (quiz.getConclusionDate() != null &amp;&amp; DateHandler.now().isAfter(quiz.getConclusionDate())) {</span>
<span class="fc" id="L312">            throw new TutorException(QUIZ_NO_LONGER_AVAILABLE);</span>
        }

<span class="fc" id="L315">        QuizAnswer quizAnswer = quizAnswerRepository.findQuizAnswer(quiz.getId(), user.getId()).orElseGet(() -&gt; {</span>
<span class="fc" id="L316">            QuizAnswer qa = new QuizAnswer(user, quiz);</span>
<span class="fc" id="L317">            quizAnswerRepository.save(qa);</span>
<span class="fc" id="L318">            return qa;</span>
        });

<span class="fc bfc" id="L321" title="All 2 branches covered.">        if (!quizAnswer.openToAnswer()) {</span>
<span class="fc" id="L322">            throw new TutorException(QUIZ_ALREADY_COMPLETED);</span>
        }

<span class="pc bpc" id="L325" title="1 of 4 branches missed.">        if (quiz.getAvailableDate() == null || DateHandler.now().isAfter(quiz.getAvailableDate())) {</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">            if (quizAnswer.getCreationDate() == null) {</span>
<span class="fc" id="L327">                quizAnswer.setCreationDate(DateHandler.now());</span>
            }
<span class="fc" id="L329">            return new StatementQuizDto(quizAnswer, false);</span>

            // Send timer
        } else {
<span class="fc" id="L333">            StatementQuizDto quizDto = new StatementQuizDto();</span>
<span class="fc" id="L334">            quizDto.setTimeToAvailability(ChronoUnit.MILLIS.between(DateHandler.now(), quiz.getAvailableDate()));</span>
<span class="fc" id="L335">            return quizDto;</span>
        }
    }

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_COMMITTED, readOnly = true)
    public List&lt;QuizDto&gt; getAvailableQuizzes(int userId, int executionId) {
<span class="fc" id="L344">        LocalDateTime now = DateHandler.now();</span>
<span class="fc" id="L345">        Set&lt;Integer&gt; answeredQuizIds = quizAnswerRepository.findClosedQuizAnswersQuizIds(userId, executionId, now);</span>

<span class="fc" id="L347">        Set&lt;Quiz&gt; openQuizzes = quizAnswerRepository.findOpenNonQRCodeQuizAnswers(userId, executionId, now);</span>

<span class="fc" id="L349">        return Stream.concat(quizRepository.findAvailableNonQRCodeNonGeneratedNonTournamentQuizzes(executionId, DateHandler.now()).stream(),</span>
<span class="fc" id="L350">                openQuizzes.stream())</span>
<span class="fc bfc" id="L351" title="All 2 branches covered.">                .filter(quiz -&gt; !answeredQuizIds.contains(quiz.getId()))</span>
<span class="fc" id="L352">                .distinct()</span>
<span class="fc" id="L353">                .map(quiz -&gt; quiz.getDto(false))</span>
<span class="fc" id="L354">                .sorted(Comparator.comparing(QuizDto::getAvailableDate, Comparator.nullsLast(Comparator.naturalOrder())))</span>
<span class="fc" id="L355">                .collect(Collectors.toList());</span>

    }

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_COMMITTED, readOnly = true)
    public List&lt;SolvedQuizDto&gt; getSolvedQuizzes(int userId, int executionId) {
<span class="pc" id="L364">        User user = userRepository.findUserWithQuizAnswersAndQuestionAnswersById(userId).orElseThrow(() -&gt; new TutorException(USER_NOT_FOUND, userId));</span>

<span class="fc" id="L366">        return user.getQuizAnswers().stream()</span>
<span class="fc" id="L367">                .filter(quizAnswer -&gt; quizAnswer.canResultsBePublic(executionId))</span>
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">                .filter(quizAnswer -&gt; quizAnswer.getAnswerDate() != null)</span>
<span class="fc" id="L369">                .map(SolvedQuizDto::new)</span>
<span class="fc" id="L370">                .sorted(Comparator.comparing(SolvedQuizDto::getAnswerDate))</span>
<span class="fc" id="L371">                .collect(Collectors.toList());</span>
    }

    @Transactional(isolation = Isolation.READ_COMMITTED)
    public StatementQuestionDto getQuestionForQuizAnswer(Integer quizId, Integer questionId) {
<span class="nc" id="L376">            Question question = questionRepository.findById(questionId)</span>
<span class="nc" id="L377">                    .orElseThrow(() -&gt; new TutorException(QUESTION_NOT_FOUND, questionId));</span>
<span class="nc" id="L378">            return new StatementQuestionDto(question);</span>
    }

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_UNCOMMITTED)
    public void submitAnswer(String username, int quizId, StatementAnswerDto answer) {
<span class="nc bnc" id="L386" title="All 2 branches missed.">        if (answer.getTimeToSubmission() == null) {</span>
<span class="nc" id="L387">            answer.setTimeToSubmission(0);</span>
        }

<span class="nc bnc" id="L390" title="All 2 branches missed.">        if (answer.emptyAnswer()) {</span>
<span class="nc" id="L391">            questionAnswerItemRepository.insertQuestionAnswerItemOptionIdNull(username, quizId, answer.getQuizQuestionId(), DateHandler.now(),</span>
<span class="nc" id="L392">                    answer.getTimeTaken(), answer.getTimeToSubmission());</span>
        } else {
<span class="nc" id="L394">            questionAnswerItemRepository.save(answer.getQuestionAnswerItem(username, quizId));</span>
        }
<span class="nc" id="L396">    }</span>

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void writeQuizAnswersAndCalculateStatistics() {
<span class="nc" id="L403">        Set&lt;Integer&gt; quizzesToWrite = quizAnswerItemRepository.findQuizzesToWrite();</span>
<span class="nc" id="L404">        quizzesToWrite.forEach(quizToWrite -&gt; {</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">            if (quizRepository.findById(quizToWrite).isPresent()) {</span>
<span class="nc" id="L406">                writeQuizAnswers(quizToWrite);</span>
            }
<span class="nc" id="L408">        });</span>

<span class="nc" id="L410">        Set&lt;QuizAnswer&gt; quizAnswersToClose = quizAnswerRepository.findQuizAnswersToCalculateStatistics(DateHandler.now());</span>

<span class="nc" id="L412">        quizAnswersToClose.forEach(QuizAnswer::calculateStatistics);</span>
<span class="nc" id="L413">    }</span>

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 2000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public StatementQuizDto startQuiz(int userId, int quizId) {
<span class="pc" id="L420">        User user = userRepository.findById(userId).orElseThrow(() -&gt; new TutorException(USER_NOT_FOUND, userId));</span>
<span class="pc" id="L421">        Quiz quiz = quizRepository.findById(quizId).orElseThrow(() -&gt; new TutorException(QUIZ_NOT_FOUND, quizId));</span>

<span class="pc bpc" id="L423" title="1 of 2 branches missed.">        if (!user.getCourseExecutions().contains(quiz.getCourseExecution())) {</span>
<span class="nc" id="L424">            throw new TutorException(USER_NOT_ENROLLED, user.getUsername());</span>
        }

<span class="pc bpc" id="L427" title="1 of 4 branches missed.">        if (quiz.getAvailableDate() != null &amp;&amp; quiz.getAvailableDate().isAfter(DateHandler.now())) {</span>
<span class="fc" id="L428">            throw new TutorException(QUIZ_NOT_YET_AVAILABLE);</span>
        }

<span class="fc bfc" id="L431" title="All 4 branches covered.">        if (quiz.getConclusionDate() != null &amp;&amp; DateHandler.now().isAfter(quiz.getConclusionDate())) {</span>
<span class="fc" id="L432">            throw new TutorException(QUIZ_NO_LONGER_AVAILABLE);</span>
        }

<span class="fc" id="L435">        Optional&lt;QuizAnswer&gt; optionalQuizAnswer = quizAnswerRepository.findQuizAnswer(quizId, userId);</span>

<span class="fc bfc" id="L437" title="All 4 branches covered.">        if (!optionalQuizAnswer.isPresent() &amp;&amp; quiz.isQrCodeOnly()) {</span>
<span class="fc" id="L438">            throw new TutorException(CANNOT_START_QRCODE_QUIZ);</span>
        }

<span class="fc" id="L441">        QuizAnswer quizAnswer = optionalQuizAnswer.orElseGet(() -&gt; {</span>
<span class="fc" id="L442">            QuizAnswer qa = new QuizAnswer(user, quiz);</span>
<span class="fc" id="L443">            quizAnswerRepository.save(qa);</span>
<span class="fc" id="L444">            return qa;</span>
        });

<span class="fc bfc" id="L447" title="All 2 branches covered.">        if (!quizAnswer.openToAnswer()) {</span>
<span class="fc" id="L448">            throw new TutorException(QUIZ_ALREADY_COMPLETED);</span>
        }

<span class="fc bfc" id="L451" title="All 2 branches covered.">        if (quizAnswer.getCreationDate() == null) {</span>
<span class="fc" id="L452">            quizAnswer.setCreationDate(DateHandler.now());</span>
        }

<span class="fc" id="L455">        return new StatementQuizDto(quizAnswer, false);</span>
    }

    public List&lt;Question&gt; filterByAssessment(List&lt;Question&gt; availableQuestions, StatementCreationDto quizDetails) {
<span class="fc" id="L459">        Assessment assessment = assessmentRepository.findById(quizDetails.getAssessment())</span>
<span class="pc" id="L460">                .orElseThrow(() -&gt; new TutorException(ASSESSMENT_NOT_FOUND, quizDetails.getAssessment()));</span>

<span class="fc" id="L462">        return availableQuestions.stream().filter(question -&gt; question.belongsToAssessment(assessment)).collect(Collectors.toList());</span>
    }

    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void resetDemoAnswers() {
<span class="nc" id="L467">        Set&lt;QuestionAnswerItem&gt; questionAnswerItems = questionAnswerItemRepository.findDemoStudentQuestionAnswerItems();</span>
<span class="nc" id="L468">        questionAnswerItems.forEach(questionAnswerItem -&gt; questionAnswerItemRepository.delete(questionAnswerItem));</span>

<span class="nc" id="L470">        Set&lt;QuizAnswer&gt; quizAnswers = quizAnswerRepository.findByExecutionCourseId(courseExecutionService.getDemoCourse().getCourseExecutionId());</span>

<span class="nc" id="L472">        quizAnswers.forEach(quizAnswer -&gt; {</span>
<span class="nc" id="L473">                quizAnswer.remove();</span>
<span class="nc" id="L474">                quizAnswerRepository.delete(quizAnswer);</span>
<span class="nc" id="L475">        });</span>
<span class="nc" id="L476">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>