<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>User.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tutor</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.socialsoftware.tutor.user.domain</a> &gt; <span class="el_source">User.java</span></div><h1>User.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.socialsoftware.tutor.user.domain;

import pt.ulisboa.tecnico.socialsoftware.dtos.quiz.QuizType;
import pt.ulisboa.tecnico.socialsoftware.dtos.user.StudentDto;
import pt.ulisboa.tecnico.socialsoftware.dtos.user.UserDto;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.domain.QuestionAnswer;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.domain.QuizAnswer;
import pt.ulisboa.tecnico.socialsoftware.tutor.auth.domain.AuthUser;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.domain.Discussion;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.domain.Reply;
import pt.ulisboa.tecnico.socialsoftware.exceptions.TutorException;
import pt.ulisboa.tecnico.socialsoftware.tutor.execution.domain.CourseExecution;
import pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain.DomainEntity;
import pt.ulisboa.tecnico.socialsoftware.tutor.impexp.domain.Visitor;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.domain.Question;
import pt.ulisboa.tecnico.socialsoftware.tutor.questionsubmission.domain.QuestionSubmission;
import pt.ulisboa.tecnico.socialsoftware.tutor.questionsubmission.domain.Review;
import pt.ulisboa.tecnico.socialsoftware.tutor.quiz.domain.Quiz;
import pt.ulisboa.tecnico.socialsoftware.utils.DateHandler;

import javax.persistence.*;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

import static pt.ulisboa.tecnico.socialsoftware.exceptions.ErrorMessage.*;

@Entity
@Table(name = &quot;users&quot;)
public class User implements DomainEntity {
<span class="fc" id="L31">    public enum Role {STUDENT, TEACHER, ADMIN, DEMO_ADMIN}</span>

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Integer id;

    @Column(unique=true)
    private Integer key;

    @Enumerated(EnumType.STRING)
    private Role role;

    private String name;

    @Column(columnDefinition = &quot;boolean default false&quot;)
    private Boolean admin;

<span class="fc" id="L48">    private Integer numberOfTeacherQuizzes = 0;</span>
<span class="fc" id="L49">    private Integer numberOfStudentQuizzes = 0;</span>
<span class="fc" id="L50">    private Integer numberOfInClassQuizzes = 0;</span>
<span class="fc" id="L51">    private Integer numberOfTeacherAnswers = 0;</span>
<span class="fc" id="L52">    private Integer numberOfInClassAnswers = 0;</span>
<span class="fc" id="L53">    private Integer numberOfStudentAnswers = 0;</span>
<span class="fc" id="L54">    private Integer numberOfCorrectTeacherAnswers = 0;</span>
<span class="fc" id="L55">    private Integer numberOfCorrectInClassAnswers = 0;</span>
<span class="fc" id="L56">    private Integer numberOfCorrectStudentAnswers = 0;</span>

<span class="fc" id="L58">    @OneToMany(mappedBy = &quot;user&quot;, fetch = FetchType.LAZY)</span>
    private Set&lt;Discussion&gt; discussions = new HashSet&lt;&gt;();

<span class="fc" id="L61">    @OneToMany(mappedBy = &quot;user&quot;, fetch = FetchType.LAZY)</span>
    private Set&lt;Reply&gt; replies = new HashSet&lt;&gt;();

    @Column(name = &quot;creation_date&quot;)
    private LocalDateTime creationDate;

    @OneToOne(cascade = CascadeType.ALL, mappedBy = &quot;user&quot;, fetch = FetchType.LAZY, orphanRemoval=true)
    public AuthUser authUser;

<span class="fc" id="L70">    @OneToMany(cascade = CascadeType.ALL, mappedBy = &quot;user&quot;, fetch = FetchType.LAZY)</span>
    private Set&lt;QuizAnswer&gt; quizAnswers = new HashSet&lt;&gt;();

<span class="fc" id="L73">    @OneToMany(cascade = CascadeType.ALL, mappedBy = &quot;submitter&quot;, fetch = FetchType.LAZY)</span>
    private Set&lt;QuestionSubmission&gt; questionSubmissions = new HashSet&lt;&gt;();

<span class="fc" id="L76">    @OneToMany(cascade = CascadeType.ALL, mappedBy = &quot;user&quot;, fetch = FetchType.LAZY)</span>
    private Set&lt;Review&gt; reviews = new HashSet&lt;&gt;();

<span class="fc" id="L79">    @ManyToMany</span>
    private Set&lt;CourseExecution&gt; courseExecutions = new HashSet&lt;&gt;();

<span class="fc" id="L82">    public User() {</span>
<span class="fc" id="L83">    }</span>

<span class="fc" id="L85">    public User(String name, String username, String email, Role role, boolean isAdmin, AuthUser.Type type){</span>
<span class="fc" id="L86">        setName(name);</span>
<span class="fc" id="L87">        setRole(role);</span>
<span class="fc" id="L88">        setAdmin(isAdmin);</span>
<span class="fc" id="L89">        setAuthUser(AuthUser.createAuthUser(this, username, email, type));</span>
<span class="fc" id="L90">        setCreationDate(DateHandler.now());</span>
<span class="fc" id="L91">    }</span>

<span class="fc" id="L93">    public User(String name, User.Role role, boolean isAdmin){</span>
<span class="fc" id="L94">        setName(name);</span>
<span class="fc" id="L95">        setRole(role);</span>
<span class="fc" id="L96">        setAdmin(isAdmin);</span>
<span class="fc" id="L97">        setCreationDate(DateHandler.now());</span>
<span class="fc" id="L98">    }</span>

    @Override
    public void accept(Visitor visitor) {
<span class="nc" id="L102">        visitor.visitUser(this);</span>
<span class="nc" id="L103">    }</span>

    public Integer getId() {
<span class="fc" id="L106">        return id;</span>
    }

    public Integer getKey() {
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (this.key == null) {</span>
<span class="fc" id="L111">            this.key = this.id;</span>
        }
<span class="fc" id="L113">        return key;</span>
    }

    public void setKey(Integer key) {
<span class="fc" id="L117">        this.key = key;</span>
<span class="fc" id="L118">    }</span>

    public void setId(Integer id) {
<span class="nc" id="L121">        this.id = id;</span>
<span class="nc" id="L122">    }</span>

    public Boolean getAdmin() {
<span class="nc" id="L125">        return admin;</span>
    }

    public void setAdmin(Boolean admin) {
<span class="fc" id="L129">        this.admin = admin;</span>
<span class="fc" id="L130">    }</span>

    public Set&lt;Discussion&gt; getDiscussions() {
<span class="nc" id="L133">        return discussions;</span>
    }

<span class="fc" id="L136">    public void addDiscussion(Discussion discussion) {this.discussions.add(discussion);}</span>

    public void setDiscussions(Set&lt;Discussion&gt; discussions) {
<span class="nc" id="L139">        this.discussions = discussions;</span>
<span class="nc" id="L140">    }</span>

    public Set&lt;Reply&gt; getReplies() {
<span class="nc" id="L143">        return replies;</span>
    }

    public void setReplies(Set&lt;Reply&gt; replies) {
<span class="nc" id="L147">        this.replies = replies;</span>
<span class="nc" id="L148">    }</span>

    public void setQuizAnswers(Set&lt;QuizAnswer&gt; quizAnswers) {
<span class="nc" id="L151">        this.quizAnswers = quizAnswers;</span>
<span class="nc" id="L152">    }</span>

    public String getUsername() {
<span class="fc bfc" id="L155" title="All 2 branches covered.">        if (authUser == null) {</span>
<span class="fc" id="L156">            String role = getRole().toString().toLowerCase();</span>
<span class="fc" id="L157">            return String.format(&quot;%s-%s&quot;, role, getId());</span>
        }
<span class="fc" id="L159">        return authUser.getUsername();</span>
    }

    public String getName() {
<span class="fc" id="L163">        return name;</span>
    }

    public void setName(String name) {
<span class="fc" id="L167">        this.name = name;</span>
<span class="fc" id="L168">    }</span>

    public boolean isAdmin() {
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        return  this.admin == null ? false : this.admin;</span>
    }

    public void setAdmin(boolean admin) {
<span class="fc" id="L175">        this.admin = admin;</span>
<span class="fc" id="L176">    }</span>

    public Role getRole() {
<span class="fc" id="L179">        return role;</span>
    }

    public void addReply(Reply reply) {
<span class="fc" id="L183">        this.replies.add(reply);</span>
<span class="fc" id="L184">    }</span>

<span class="nc" id="L186">    public void removeReply(Reply reply) {this.replies.remove(reply);}</span>

    public void setRole(Role role) {
<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (role == null)</span>
<span class="fc" id="L190">            throw new TutorException(INVALID_ROLE);</span>

<span class="fc" id="L192">        this.role = role;</span>
<span class="fc" id="L193">    }</span>

    public LocalDateTime getCreationDate() {
<span class="fc" id="L196">        return creationDate;</span>
    }

    public void setCreationDate(LocalDateTime creationDate) {
<span class="fc" id="L200">        this.creationDate = creationDate;</span>
<span class="fc" id="L201">    }</span>

    public Set&lt;QuizAnswer&gt; getQuizAnswers() {
<span class="fc" id="L204">        return quizAnswers;</span>
    }

    public Set&lt;CourseExecution&gt; getCourseExecutions() {
<span class="fc" id="L208">        return courseExecutions;</span>
    }

    public void setCourseExecutions(Set&lt;CourseExecution&gt; courseExecutions) {
<span class="nc" id="L212">        this.courseExecutions = courseExecutions;</span>
<span class="nc" id="L213">    }</span>

    public void setQuestionSubmissions(Set&lt;QuestionSubmission&gt; questionSubmissions) { 
<span class="nc" id="L216">        this.questionSubmissions = questionSubmissions; </span>
<span class="nc" id="L217">    }</span>
    
    public String getEmail() {
<span class="nc" id="L220">        return authUser.getEmail();</span>
    }

    public AuthUser getAuthUser() {
<span class="fc" id="L224">        return authUser;</span>
    }

    public void setAuthUser(AuthUser authUser) {
<span class="fc" id="L228">        this.authUser = authUser;</span>
<span class="fc" id="L229">    }</span>

    public Integer getNumberOfTeacherQuizzes() {
<span class="fc bfc" id="L232" title="All 2 branches covered.">        if (this.numberOfTeacherQuizzes == null)</span>
<span class="fc" id="L233">            this.numberOfTeacherQuizzes = (int) getQuizAnswers().stream()</span>
<span class="fc" id="L234">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L235">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.PROPOSED))</span>
<span class="fc" id="L236">                    .count();</span>

<span class="fc" id="L238">        return numberOfTeacherQuizzes;</span>
    }

    public void setNumberOfTeacherQuizzes(Integer numberOfTeacherQuizzes) {
<span class="fc" id="L242">        this.numberOfTeacherQuizzes = numberOfTeacherQuizzes;</span>
<span class="fc" id="L243">    }</span>

    public Integer getNumberOfStudentQuizzes() {
<span class="fc bfc" id="L246" title="All 2 branches covered.">        if (this.numberOfStudentQuizzes == null)</span>
<span class="fc" id="L247">            this.numberOfStudentQuizzes = (int) getQuizAnswers().stream()</span>
<span class="fc" id="L248">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L249">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.GENERATED))</span>
<span class="fc" id="L250">                    .count();</span>

<span class="fc" id="L252">        return numberOfStudentQuizzes;</span>
    }

    public void setNumberOfStudentQuizzes(Integer numberOfStudentQuizzes) {
<span class="fc" id="L256">        this.numberOfStudentQuizzes = numberOfStudentQuizzes;</span>
<span class="fc" id="L257">    }</span>

    public Integer getNumberOfInClassQuizzes() {
<span class="fc bfc" id="L260" title="All 2 branches covered.">        if (this.numberOfInClassQuizzes == null)</span>
<span class="fc" id="L261">            this.numberOfInClassQuizzes = (int) getQuizAnswers().stream()</span>
<span class="fc" id="L262">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L263">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.IN_CLASS))</span>
<span class="fc" id="L264">                    .count();</span>

<span class="fc" id="L266">        return numberOfInClassQuizzes;</span>
    }

    public void setNumberOfInClassQuizzes(Integer numberOfInClassQuizzes) {
<span class="fc" id="L270">        this.numberOfInClassQuizzes = numberOfInClassQuizzes;</span>
<span class="fc" id="L271">    }</span>

    public Integer getNumberOfTeacherAnswers() {
<span class="fc bfc" id="L274" title="All 2 branches covered.">        if (this.numberOfTeacherAnswers == null)</span>
<span class="fc" id="L275">            this.numberOfTeacherAnswers = getQuizAnswers().stream()</span>
<span class="fc" id="L276">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L277">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.PROPOSED))</span>
<span class="fc" id="L278">                    .mapToInt(quizAnswer -&gt; quizAnswer.getQuiz().getQuizQuestionsNumber())</span>
<span class="fc" id="L279">                    .sum();</span>

<span class="fc" id="L281">        return numberOfTeacherAnswers;</span>
    }

    public void setNumberOfTeacherAnswers(Integer numberOfTeacherAnswers) {
<span class="fc" id="L285">        this.numberOfTeacherAnswers = numberOfTeacherAnswers;</span>
<span class="fc" id="L286">    }</span>

    public Integer getNumberOfInClassAnswers() {
<span class="fc bfc" id="L289" title="All 2 branches covered.">        if (this.numberOfInClassAnswers == null)</span>
<span class="fc" id="L290">            this.numberOfInClassAnswers = getQuizAnswers().stream()</span>
<span class="fc" id="L291">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L292">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.IN_CLASS))</span>
<span class="fc" id="L293">                    .mapToInt(quizAnswer -&gt; quizAnswer.getQuiz().getQuizQuestionsNumber())</span>
<span class="fc" id="L294">                    .sum();</span>
<span class="fc" id="L295">            return numberOfInClassAnswers;</span>
    }

    public void setNumberOfInClassAnswers(Integer numberOfInClassAnswers) {
<span class="fc" id="L299">        this.numberOfInClassAnswers = numberOfInClassAnswers;</span>
<span class="fc" id="L300">    }</span>

    public Integer getNumberOfStudentAnswers() {
<span class="fc bfc" id="L303" title="All 2 branches covered.">        if (this.numberOfStudentAnswers == null) {</span>
<span class="fc" id="L304">            this.numberOfStudentAnswers = getQuizAnswers().stream()</span>
<span class="fc" id="L305">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L306">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.GENERATED))</span>
<span class="fc" id="L307">                    .mapToInt(quizAnswer -&gt; quizAnswer.getQuiz().getQuizQuestionsNumber())</span>
<span class="fc" id="L308">                    .sum();</span>
        }

<span class="fc" id="L311">        return numberOfStudentAnswers;</span>
    }

    public void setNumberOfStudentAnswers(Integer numberOfStudentAnswers) {
<span class="fc" id="L315">        this.numberOfStudentAnswers = numberOfStudentAnswers;</span>
<span class="fc" id="L316">    }</span>

    public Integer getNumberOfCorrectTeacherAnswers() {
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (this.numberOfCorrectTeacherAnswers == null)</span>
<span class="fc" id="L320">            this.numberOfCorrectTeacherAnswers = (int) this.getQuizAnswers().stream()</span>
<span class="fc" id="L321">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L322">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.PROPOSED))</span>
<span class="fc" id="L323">                    .flatMap(quizAnswer -&gt; quizAnswer.getQuestionAnswers().stream())</span>
<span class="fc" id="L324">                    .filter(QuestionAnswer::isCorrect)</span>
<span class="fc" id="L325">                    .count();</span>

<span class="fc" id="L327">            return numberOfCorrectTeacherAnswers;</span>
    }

    public void setNumberOfCorrectTeacherAnswers(Integer numberOfCorrectTeacherAnswers) {
<span class="fc" id="L331">        this.numberOfCorrectTeacherAnswers = numberOfCorrectTeacherAnswers;</span>
<span class="fc" id="L332">    }</span>

    public Integer getNumberOfCorrectInClassAnswers() {
<span class="fc bfc" id="L335" title="All 2 branches covered.">        if (this.numberOfCorrectInClassAnswers == null)</span>
<span class="fc" id="L336">            this.numberOfCorrectInClassAnswers = (int) this.getQuizAnswers().stream()</span>
<span class="fc" id="L337">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L338">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.IN_CLASS))</span>
<span class="fc" id="L339">                    .flatMap(quizAnswer -&gt; quizAnswer.getQuestionAnswers().stream())</span>
<span class="fc" id="L340">                    .filter(QuestionAnswer::isCorrect)</span>
<span class="fc" id="L341">                    .count();</span>

<span class="fc" id="L343">        return numberOfCorrectInClassAnswers;</span>
    }

    public void setNumberOfCorrectInClassAnswers(Integer numberOfCorrectInClassAnswers) {
<span class="fc" id="L347">        this.numberOfCorrectInClassAnswers = numberOfCorrectInClassAnswers;</span>
<span class="fc" id="L348">    }</span>


    public Integer getNumberOfCorrectStudentAnswers() {
<span class="fc bfc" id="L352" title="All 2 branches covered.">        if (this.numberOfCorrectStudentAnswers == null)</span>
<span class="fc" id="L353">            this.numberOfCorrectStudentAnswers = (int) this.getQuizAnswers().stream()</span>
<span class="fc" id="L354">                    .filter(QuizAnswer::isCompleted)</span>
<span class="fc" id="L355">                    .filter(quizAnswer -&gt; quizAnswer.getQuiz().getType().equals(QuizType.GENERATED))</span>
<span class="fc" id="L356">                    .flatMap(quizAnswer -&gt; quizAnswer.getQuestionAnswers().stream())</span>
<span class="fc" id="L357">                    .filter(QuestionAnswer::isCorrect)</span>
<span class="fc" id="L358">                    .count();</span>

<span class="fc" id="L360">        return numberOfCorrectStudentAnswers;</span>
    }

    public void setNumberOfCorrectStudentAnswers(Integer numberOfCorrectStudentAnswers) {
<span class="fc" id="L364">        this.numberOfCorrectStudentAnswers = numberOfCorrectStudentAnswers;</span>
<span class="fc" id="L365">    }</span>

    public Integer getNumAnsweredDiscussions() {
<span class="nc" id="L368">        return (int) this.getDiscussions().stream().filter(Discussion::teacherAnswered).count();</span>
    }

    public void setReviews(Set&lt;Review&gt; reviews) {
<span class="nc" id="L372">        this.reviews = reviews;</span>
<span class="nc" id="L373">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L377">        return &quot;User{&quot; +</span>
                &quot;id=&quot; + id +
                &quot;, key=&quot; + key +
                &quot;, role=&quot; + role +
<span class="nc" id="L381">                &quot;, username='&quot; + getUsername() + '\'' +</span>
                &quot;, name='&quot; + name + '\'' +
                &quot;, numberOfTeacherQuizzes=&quot; + numberOfTeacherQuizzes +
                &quot;, numberOfStudentQuizzes=&quot; + numberOfStudentQuizzes +
                &quot;, numberOfInClassQuizzes=&quot; + numberOfInClassQuizzes +
                &quot;, numberOfTeacherAnswers=&quot; + numberOfTeacherAnswers +
                &quot;, numberOfInClassAnswers=&quot; + numberOfInClassAnswers +
                &quot;, numberOfStudentAnswers=&quot; + numberOfStudentAnswers +
                &quot;, numberOfCorrectTeacherAnswers=&quot; + numberOfCorrectTeacherAnswers +
                &quot;, numberOfCorrectInClassAnswers=&quot; + numberOfCorrectInClassAnswers +
                &quot;, numberOfCorrectStudentAnswers=&quot; + numberOfCorrectStudentAnswers +
                &quot;, creationDate=&quot; + creationDate +
<span class="nc" id="L393">                &quot;, lastAccess=&quot; + authUser.getLastAccess() +</span>
                '}';
    }

    public void increaseNumberOfQuizzes(QuizType type) {
<span class="fc bfc" id="L398" title="All 4 branches covered.">        switch (type) {</span>
            case PROPOSED:
<span class="fc" id="L400">                this.numberOfTeacherQuizzes = getNumberOfTeacherQuizzes() + 1;</span>
<span class="fc" id="L401">                break;</span>
            case IN_CLASS:
<span class="fc" id="L403">                this.numberOfInClassQuizzes = getNumberOfInClassQuizzes() + 1;</span>
<span class="fc" id="L404">                break;</span>
            case GENERATED:
<span class="fc" id="L406">                this.numberOfStudentQuizzes = getNumberOfStudentQuizzes() + 1;</span>
<span class="fc" id="L407">                break;</span>
            default:
                break;
        }
<span class="fc" id="L411">    }</span>

    public void increaseNumberOfAnswers(QuizType type) {
<span class="nc bnc" id="L414" title="All 4 branches missed.">        switch (type) {</span>
            case PROPOSED:
<span class="nc" id="L416">                this.numberOfTeacherAnswers = getNumberOfTeacherAnswers() + 1;</span>
<span class="nc" id="L417">                break;</span>
            case IN_CLASS:
<span class="nc" id="L419">                this.numberOfInClassAnswers = getNumberOfInClassAnswers() + 1;</span>
<span class="nc" id="L420">                break;</span>
            case GENERATED:
<span class="nc" id="L422">                this.numberOfStudentAnswers = getNumberOfStudentAnswers() + 1;</span>
<span class="nc" id="L423">                break;</span>
            default:
                break;
        }
<span class="nc" id="L427">    }</span>

    public void increaseNumberOfCorrectAnswers(QuizType type) {
<span class="fc bfc" id="L430" title="All 4 branches covered.">        switch (type) {</span>
            case PROPOSED:
<span class="fc" id="L432">                this.numberOfCorrectTeacherAnswers = getNumberOfCorrectTeacherAnswers() + 1;</span>
<span class="fc" id="L433">                break;</span>
            case IN_CLASS:
<span class="fc" id="L435">                this.numberOfCorrectInClassAnswers = getNumberOfCorrectInClassAnswers() + 1;</span>
<span class="fc" id="L436">                break;</span>
            case GENERATED:
<span class="fc" id="L438">                this.numberOfCorrectStudentAnswers = getNumberOfCorrectStudentAnswers() + 1;</span>
<span class="fc" id="L439">                break;</span>
            default:
                break;
        }
<span class="fc" id="L443">    }</span>

    public void addQuizAnswer(QuizAnswer quizAnswer) {
<span class="fc" id="L446">        this.quizAnswers.add(quizAnswer);</span>
<span class="fc" id="L447">    }</span>

    public void addCourse(CourseExecution course) {
<span class="fc" id="L450">        this.courseExecutions.add(course);</span>
<span class="fc" id="L451">        course.addUser(this);</span>
<span class="fc" id="L452">    }</span>

    public void addQuestionSubmission(QuestionSubmission questionSubmission) {
<span class="fc" id="L455">        questionSubmissions.add(questionSubmission);</span>
<span class="fc" id="L456">    }</span>

<span class="fc" id="L458">    public Set&lt;QuestionSubmission&gt; getQuestionSubmissions() { return questionSubmissions; }</span>

<span class="nc" id="L460">    public Set&lt;Review&gt; getReviews() { return reviews; }</span>

<span class="fc bfc" id="L462" title="All 2 branches covered.">    public boolean isStudent() { return this.role == User.Role.STUDENT; }</span>

<span class="fc bfc" id="L464" title="All 2 branches covered.">    public boolean isTeacher() { return this.role == User.Role.TEACHER; }</span>

    public List&lt;Question&gt; filterQuestionsByStudentModel(Integer numberOfQuestions, List&lt;Question&gt; availableQuestions) {
<span class="fc" id="L467">        List&lt;Question&gt; studentAnsweredQuestions = getQuizAnswers().stream()</span>
<span class="fc" id="L468">                .flatMap(quizAnswer -&gt; quizAnswer.getQuestionAnswers().stream())</span>
<span class="fc" id="L469">                .filter(questionAnswer -&gt; availableQuestions.contains(questionAnswer.getQuizQuestion().getQuestion()))</span>
<span class="pc bpc" id="L470" title="1 of 4 branches missed.">                .filter(questionAnswer -&gt; questionAnswer.getTimeTaken() != null &amp;&amp; questionAnswer.getTimeTaken() != 0)</span>
<span class="fc" id="L471">                .map(questionAnswer -&gt; questionAnswer.getQuizQuestion().getQuestion())</span>
<span class="fc" id="L472">                .collect(Collectors.toList());</span>

<span class="fc" id="L474">        List&lt;Question&gt; notAnsweredQuestions = availableQuestions.stream()</span>
<span class="fc bfc" id="L475" title="All 2 branches covered.">                .filter(question -&gt; !studentAnsweredQuestions.contains(question))</span>
<span class="fc" id="L476">                .collect(Collectors.toList());</span>

<span class="fc" id="L478">        List&lt;Question&gt; result = new ArrayList&lt;&gt;();</span>

        // add 80% of notanswered questions
        // may add less if not enough notanswered
<span class="fc" id="L482">        int numberOfAddedQuestions = 0;</span>
<span class="fc bfc" id="L483" title="All 2 branches covered.">        while (numberOfAddedQuestions &lt; numberOfQuestions * 0.8</span>
<span class="fc bfc" id="L484" title="All 2 branches covered.">                &amp;&amp; notAnsweredQuestions.size() &gt;= numberOfAddedQuestions + 1) {</span>
<span class="fc" id="L485">            result.add(notAnsweredQuestions.get(numberOfAddedQuestions++));</span>
        }

        // add notanswered questions if there is not enough answered questions
        // it is ok because the total id of available questions &gt; numberOfQuestions
<span class="fc bfc" id="L490" title="All 2 branches covered.">        while (studentAnsweredQuestions.size() + numberOfAddedQuestions &lt; numberOfQuestions) {</span>
<span class="fc" id="L491">            result.add(notAnsweredQuestions.get(numberOfAddedQuestions++));</span>
        }

        // add answered questions
<span class="fc" id="L495">        Random rand = new Random(System.currentTimeMillis());</span>
<span class="fc bfc" id="L496" title="All 2 branches covered.">        while (numberOfAddedQuestions &lt; numberOfQuestions) {</span>
<span class="fc" id="L497">            int next = rand.nextInt(studentAnsweredQuestions.size());</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">            if (!result.contains(studentAnsweredQuestions.get(next))) {</span>
<span class="fc" id="L499">                result.add(studentAnsweredQuestions.get(next));</span>
<span class="fc" id="L500">                numberOfAddedQuestions++;</span>
            }
<span class="fc" id="L502">        }</span>

<span class="fc" id="L504">        return result;</span>
    }

    public QuizAnswer getQuizAnswer(Quiz quiz) {
<span class="nc" id="L508">        return getQuizAnswers().stream()</span>
<span class="nc bnc" id="L509" title="All 2 branches missed.">                .filter(quizAnswer -&gt; quizAnswer.getQuiz() == quiz)</span>
<span class="nc" id="L510">                .findAny()</span>
<span class="nc" id="L511">                .orElse(null);</span>
    }

    public void remove() {
<span class="pc bpc" id="L515" title="1 of 6 branches missed.">        if (getAuthUser() != null &amp;&amp; !getAuthUser().isDemoStudent() &amp;&amp; getAuthUser().isActive()) {</span>
<span class="fc" id="L516">                throw new TutorException(USER_IS_ACTIVE, getUsername());</span>
        }

<span class="pc bpc" id="L519" title="1 of 2 branches missed.">        if (quizAnswers.size() != 0) {</span>
<span class="nc" id="L520">            throw new TutorException(USER_HAS_QUIZ_ANSWERS, getUsername());</span>
        }

<span class="pc bpc" id="L523" title="1 of 2 branches missed.">        if (questionSubmissions.size() != 0) {</span>
<span class="nc" id="L524">            throw new TutorException(USER_HAS_QUESTION_SUBMISSIONS, getUsername());</span>
        }

<span class="pc bpc" id="L527" title="1 of 2 branches missed.">        if (discussions.size() != 0) {</span>
<span class="nc" id="L528">            throw new TutorException(USER_HAS_DISCUSSIONS, getUsername());</span>
        }

<span class="pc bpc" id="L531" title="1 of 2 branches missed.">        if (replies.size() != 0) {</span>
<span class="nc" id="L532">            throw new TutorException(USER_HAS_REPLIES, getUsername());</span>
        }

<span class="fc" id="L535">        courseExecutions.forEach(ce -&gt; ce.getUsers().remove(this));</span>
<span class="fc" id="L536">        courseExecutions.clear();</span>
<span class="fc" id="L537">    }</span>

    public UserDto getUserDto() {
<span class="fc" id="L540">        UserDto dto = new UserDto();</span>
<span class="fc" id="L541">        dto.setId(getId());</span>
<span class="fc" id="L542">        dto.setUsername(getUsername());</span>
<span class="fc" id="L543">        dto.setEmail(getAuthUser().getEmail());</span>
<span class="fc" id="L544">        dto.setName(getName());</span>
<span class="fc" id="L545">        dto.setRole(getRole().toString());</span>
<span class="fc" id="L546">        dto.setActive(getAuthUser().isActive());</span>
<span class="fc" id="L547">        dto.setCreationDate(DateHandler.toISOString(getCreationDate()));</span>
<span class="fc" id="L548">        dto.setLastAccess(DateHandler.toISOString(getAuthUser().getLastAccess()));</span>
<span class="fc" id="L549">        return dto;</span>
    }

    public StudentDto getStudentDto() {
<span class="fc" id="L553">        UserDto userDto = getUserDto();</span>
<span class="fc" id="L554">        StudentDto studentDto = new StudentDto();</span>

<span class="fc" id="L556">        studentDto.setId(userDto.getId());</span>
<span class="fc" id="L557">        studentDto.setUsername(userDto.getUsername());</span>
<span class="fc" id="L558">        studentDto.setEmail(userDto.getEmail());</span>
<span class="fc" id="L559">        studentDto.setName(userDto.getName());</span>
<span class="fc" id="L560">        studentDto.setRole(userDto.getRole());</span>
<span class="fc" id="L561">        studentDto.setActive(userDto.isActive());</span>
<span class="fc" id="L562">        studentDto.setCreationDate(userDto.getCreationDate());</span>
<span class="fc" id="L563">        studentDto.setLastAccess(userDto.getLastAccess());</span>

<span class="fc" id="L565">        studentDto.setNumberOfInClassQuizzes(getNumberOfInClassQuizzes());</span>
<span class="fc" id="L566">        studentDto.setNumberOfStudentQuizzes(getNumberOfStudentQuizzes());</span>
<span class="fc" id="L567">        studentDto.setNumberOfAnswers(getNumberOfTeacherAnswers() + getNumberOfInClassAnswers() + getNumberOfStudentAnswers());</span>
<span class="fc" id="L568">        studentDto.setNumberOfTeacherAnswers(getNumberOfTeacherAnswers());</span>
<span class="fc" id="L569">        studentDto.setNumberOfInClassAnswers(getNumberOfInClassAnswers());</span>
<span class="fc" id="L570">        studentDto.setNumberOfStudentAnswers(getNumberOfStudentAnswers());</span>

<span class="pc bpc" id="L572" title="1 of 2 branches missed.">        if (this.numberOfTeacherAnswers != 0)</span>
<span class="nc" id="L573">            studentDto.setPercentageOfCorrectTeacherAnswers(getNumberOfCorrectTeacherAnswers() * 100 / getNumberOfTeacherAnswers());</span>
<span class="pc bpc" id="L574" title="1 of 2 branches missed.">        if (this.numberOfInClassAnswers != 0)</span>
<span class="nc" id="L575">            studentDto.setPercentageOfCorrectInClassAnswers(getNumberOfCorrectInClassAnswers() * 100 / getNumberOfInClassAnswers());</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">        if (this.numberOfStudentAnswers != 0)</span>
<span class="nc" id="L577">            studentDto.setPercentageOfCorrectStudentAnswers(getNumberOfCorrectStudentAnswers() * 100 / getNumberOfStudentAnswers());</span>
<span class="pc bpc" id="L578" title="1 of 2 branches missed.">        if (studentDto.getNumberOfAnswers() != 0)</span>
<span class="nc" id="L579">            studentDto.setPercentageOfCorrectAnswers((getNumberOfCorrectTeacherAnswers() + getNumberOfCorrectInClassAnswers() + getNumberOfCorrectStudentAnswers())  * 100 / studentDto.getNumberOfAnswers());</span>

<span class="fc" id="L581">        return studentDto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>