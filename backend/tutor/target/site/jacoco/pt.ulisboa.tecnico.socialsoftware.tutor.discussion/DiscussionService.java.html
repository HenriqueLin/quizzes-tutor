<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="pt"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiscussionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">tutor</a> &gt; <a href="index.source.html" class="el_package">pt.ulisboa.tecnico.socialsoftware.tutor.discussion</a> &gt; <span class="el_source">DiscussionService.java</span></div><h1>DiscussionService.java</h1><pre class="source lang-java linenums">package pt.ulisboa.tecnico.socialsoftware.tutor.discussion;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.retry.annotation.Backoff;
import org.springframework.retry.annotation.Retryable;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Transactional;
import pt.ulisboa.tecnico.socialsoftware.exceptions.TutorException;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.domain.QuestionAnswer;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.repository.QuestionAnswerRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.answer.repository.QuizAnswerRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.domain.Discussion;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.domain.Reply;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.dto.DiscussionDto;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.dto.ReplyDto;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.repository.DiscussionRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.discussion.repository.ReplyRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.execution.CourseExecutionService;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.api.TopicController;
import pt.ulisboa.tecnico.socialsoftware.tutor.question.repository.QuestionRepository;
import pt.ulisboa.tecnico.socialsoftware.tutor.user.domain.User;
import pt.ulisboa.tecnico.socialsoftware.tutor.user.repository.UserRepository;

import java.sql.SQLException;
import java.util.List;
import java.util.stream.Collectors;

import static pt.ulisboa.tecnico.socialsoftware.exceptions.ErrorMessage.*;

@Service
<span class="fc" id="L34">public class DiscussionService {</span>
<span class="fc" id="L35">    private static final Logger logger = LoggerFactory.getLogger(TopicController.class);</span>

    @Autowired
    public DiscussionRepository discussionRepository;

    @Autowired
    public UserRepository userRepository;

    @Autowired
    public QuestionRepository questionRepository;

    @Autowired
    public ReplyRepository replyRepository;

    @Autowired
    public QuizAnswerRepository quizAnswerRepository;

    @Autowired
    public QuestionAnswerRepository questionAnswerRepository;

    @Autowired
    private CourseExecutionService courseExecutionService;

    @Retryable(
            value = { SQLException.class },
            backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public DiscussionDto createDiscussion(int questionAnswerId, DiscussionDto discussionDto) {
<span class="pc" id="L63">        QuestionAnswer questionAnswer = questionAnswerRepository.findById(questionAnswerId).orElseThrow(() -&gt; new TutorException(QUESTION_ANSWER_NOT_FOUND, questionAnswerId));</span>
<span class="fc" id="L64">        Discussion discussion = new Discussion(questionAnswer, discussionDto);</span>

<span class="fc" id="L66">        discussionRepository.save(discussion);</span>

<span class="fc" id="L68">        return new DiscussionDto(discussion, false);</span>
    }

    @Retryable(value = { SQLException.class }, backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public DiscussionDto changeStatus(int discussionId) {
<span class="fc" id="L74">        Discussion discussion = discussionRepository</span>
<span class="fc" id="L75">                .findById(discussionId)</span>
<span class="pc" id="L76">                .orElseThrow(() -&gt; new TutorException(DISCUSSION_NOT_FOUND, discussionId));</span>

<span class="fc" id="L78">        discussion.changeStatus();</span>
<span class="fc" id="L79">        return new DiscussionDto(discussion, false);</span>
    }

    @Retryable(value = { SQLException.class }, backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public DiscussionDto changeReplyAvailability(int replyId) {
<span class="fc" id="L85">        Reply reply = replyRepository</span>
<span class="fc" id="L86">                .findById(replyId)</span>
<span class="pc" id="L87">                .orElseThrow(() -&gt; new TutorException(REPLY_NOT_FOUND, replyId));</span>

<span class="fc" id="L89">        reply.changeAvailability();</span>
<span class="fc" id="L90">        return new DiscussionDto(reply.getDiscussion(), false);</span>
    }

    @Retryable(value = { SQLException.class }, backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public ReplyDto addReply(int userId, int discussionId, ReplyDto replyDto) {
<span class="pc" id="L96">        User user = userRepository.findById(userId).orElseThrow(()-&gt;new TutorException(USER_NOT_FOUND, userId));</span>

<span class="fc" id="L98">        Discussion discussion = discussionRepository</span>
<span class="fc" id="L99">                .findById(discussionId)</span>
<span class="pc" id="L100">                .orElseThrow(() -&gt; new TutorException(DISCUSSION_NOT_FOUND, discussionId));</span>

<span class="fc" id="L102">        Reply reply = new Reply(user, replyDto, discussion);</span>
<span class="fc" id="L103">        replyRepository.save(reply);</span>

<span class="fc" id="L105">        return new ReplyDto(reply);</span>
    }

    @Retryable(value = { SQLException.class }, backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public List&lt;DiscussionDto&gt; findDiscussionsByCourseExecutionId(int courseExecutionId)  {
<span class="nc" id="L111">        return discussionRepository.findDiscussionsByCourseExecution(courseExecutionId).stream().map(discussion -&gt; new DiscussionDto(discussion, true))</span>
<span class="nc" id="L112">                .collect(Collectors.toList());</span>
    }

    @Retryable(value = { SQLException.class }, backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public List&lt;DiscussionDto&gt; findOpenDiscussionsByCourseExecutionId(int courseExecutionId)  {
<span class="nc" id="L118">        return discussionRepository.</span>
<span class="nc" id="L119">                findOpenDiscussionsByCourseExecutionId(courseExecutionId).</span>
<span class="nc" id="L120">                stream().map(discussion -&gt; new DiscussionDto(discussion, true)).collect(Collectors.toList());</span>
    }

    @Retryable(value = { SQLException.class }, backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public List&lt;DiscussionDto&gt; findByCourseExecutionIdAndUserId(Integer courseExecutionId, Integer userId) {
<span class="fc" id="L126">        return discussionRepository.findDiscussionsByCourseExecutionIdAndUserId(courseExecutionId, userId).stream().map(discussion -&gt; new DiscussionDto(discussion, true))</span>
<span class="fc" id="L127">                .collect(Collectors.toList());</span>
    }

    @Retryable(value = { SQLException.class }, backoff = @Backoff(delay = 5000))
    @Transactional(isolation = Isolation.READ_COMMITTED)
    public List&lt;ReplyDto&gt; findClarificationsByQuestionId(Integer questionId) {
<span class="nc" id="L133">        return replyRepository.findClarificationsByQuestionId(questionId).stream().map(ReplyDto::new).collect(Collectors.toList());</span>
    }

    @Transactional(isolation = Isolation.READ_COMMITTED)
    public DiscussionDto findDiscussionById(Integer discussionId, boolean deep) {
<span class="nc" id="L138">         return discussionRepository.findById(discussionId)</span>
<span class="nc" id="L139">                 .map(discussion -&gt; new DiscussionDto(discussion, deep))</span>
<span class="nc" id="L140">                 .orElse(null);</span>
    }

    @Transactional(isolation = Isolation.READ_COMMITTED)
    public void resetDemoDiscussions() {
<span class="nc" id="L145">        List&lt;Discussion&gt; discussions = discussionRepository.findByExecutionCourseId(courseExecutionService.getDemoCourse().getCourseExecutionId());</span>

<span class="nc" id="L147">        discussions.forEach(discussion -&gt; {</span>
<span class="nc" id="L148">            discussion.remove();</span>
<span class="nc" id="L149">            discussionRepository.delete(discussion);</span>
<span class="nc" id="L150">        });</span>

<span class="nc" id="L152">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>